<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-Side REST API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        .mono { font-family: 'Fira Code', monospace; }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        .status-online { background: #10b981; box-shadow: 0 0 12px #10b981; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto space-y-6">
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-8 rounded-2xl shadow-2xl">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-black mb-2">Client-Side REST API</h1>
                    <p class="text-blue-100">Orchestrateur API dans le navigateur</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center gap-2 text-sm font-bold">
                        <span class="status-dot status-online"></span>
                        API ACTIVE
                    </div>
                    <div class="text-xs text-blue-100 mt-1 mono" id="session-id"></div>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                ðŸ“¡ Endpoints disponibles
            </h2>
            <div class="space-y-2 text-sm mono">
                <div class="bg-green-900/30 border border-green-700 p-3 rounded">
                    <span class="text-green-400 font-bold">GET</span> 
                    <span class="text-gray-300">/api/status</span>
                    <span class="text-gray-500 ml-4">â†’ Ã‰tat du serveur simulÃ©</span>
                </div>
                <div class="bg-blue-900/30 border border-blue-700 p-3 rounded">
                    <span class="text-blue-400 font-bold">POST</span> 
                    <span class="text-gray-300">/api/process</span>
                    <span class="text-gray-500 ml-4">â†’ Traitement de texte</span>
                </div>
                <div class="bg-green-900/30 border border-green-700 p-3 rounded">
                    <span class="text-green-400 font-bold">GET</span> 
                    <span class="text-gray-300">/api/data</span>
                    <span class="text-gray-500 ml-4">â†’ Simulation base de donnÃ©es</span>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4">ðŸ§ª Interface de Test</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-400 mb-2">Endpoint</label>
                    <select id="endpoint" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white">
                        <option value="GET /api/status">GET /api/status</option>
                        <option value="GET /api/data">GET /api/data</option>
                        <option value="POST /api/process">POST /api/process</option>
                    </select>
                </div>

                <div id="body-section" class="hidden">
                    <label class="block text-sm font-bold text-gray-400 mb-2">Body (JSON)</label>
                    <textarea id="request-body" rows="4" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white mono text-sm" placeholder='{"text": "Hello World"}'></textarea>
                </div>

                <button onclick="testAPI()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 rounded-lg shadow-lg transition-all active:scale-95">
                    Envoyer la RequÃªte
                </button>

                <div id="response-section" class="hidden">
                    <h3 class="text-sm font-bold text-gray-400 mb-2">RÃ©ponse du "Serveur" :</h3>
                    <pre id="response-output" class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-sm mono overflow-x-auto text-green-400"></pre>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4">ðŸ“Š Logs API (Temps RÃ©el)</h2>
            <div id="logs" class="space-y-2 max-h-64 overflow-y-auto text-sm mono font-medium"></div>
        </div>
    </div>

    <script>
        // ========== API REST CÃ”TÃ‰ CLIENT (CORRIGÃ‰E) ==========
        
        // 1. Ã‰tat global (Simulation de Database)
        const API_STATE = {
            sessionId: 'sess_' + Math.random().toString(36).substr(2, 9),
            startTime: Date.now(),
            db: [
                { id: 1, name: "DonnÃ©e Initiale", value: 42 }
            ],
            requestCount: 0
        };

        document.getElementById('session-id').textContent = `Session: ${API_STATE.sessionId}`;

        // 2. Le "Routeur" (Cerveau de l'API)
        // C'est cette fonction qui remplace le serveur backend
        async function router(method, path, body = null) {
            API_STATE.requestCount++;
            
            // Simulation de latence rÃ©seau (optionnel, pour faire vrai)
            await new Promise(r => setTimeout(r, 300));

            // --- ROUTE: GET /api/status ---
            if (method === 'GET' && path === '/api/status') {
                return {
                    status: 200,
                    data: {
                        online: true,
                        uptime: `${Math.floor((Date.now() - API_STATE.startTime) / 1000)}s`,
                        requests_handled: API_STATE.requestCount,
                        session: API_STATE.sessionId
                    }
                };
            }

            // --- ROUTE: GET /api/data ---
            if (method === 'GET' && path === '/api/data') {
                return {
                    status: 200,
                    data: {
                        count: API_STATE.db.length,
                        items: API_STATE.db
                    }
                };
            }

            // --- ROUTE: POST /api/process ---
            if (method === 'POST' && path === '/api/process') {
                if (!body || !body.text) {
                    return { status: 400, data: { error: "Champ 'text' requis dans le body" } };
                }
                
                const text = body.text;
                // Logique mÃ©tier "Complexe"
                const result = {
                    original: text,
                    transformations: {
                        uppercase: text.toUpperCase(),
                        reverse: text.split('').reverse().join(''),
                        length: text.length
                    },
                    processed_at: new Date().toISOString()
                };

                return { status: 201, data: result };
            }

            // --- 404 NOT FOUND ---
            return {
                status: 404,
                data: { error: `Endpoint inconnu: ${method} ${path}` }
            };
        }

        // 3. Fonction Client (Celle qui est appelÃ©e par le bouton)
        async function testAPI() {
            const endpointSelect = document.getElementById('endpoint').value;
            // CORRECTION: Le split fonctionne maintenant car j'ai mis "METHOD PATH" dans les values du select
            const [method, path] = endpointSelect.split(' '); 

            let body = null;
            
            // Gestion du Body pour POST/PUT
            if (['POST', 'PUT'].includes(method)) {
                try {
                    const rawBody = document.getElementById('request-body').value;
                    if(rawBody) body = JSON.parse(rawBody);
                } catch (e) {
                    log('âŒ JSON invalide dans le body', 'error');
                    return;
                }
            }

            log(`ðŸš€ Envoi: ${method} ${path}`, 'info');

            try {
                // Appel au routeur (simulation de fetch)
                const response = await router(method, path, body);

                // Affichage du rÃ©sultat
                const output = document.getElementById('response-output');
                const section = document.getElementById('response-section');
                
                section.classList.remove('hidden');
                output.textContent = JSON.stringify(response.data, null, 2);

                if (response.status >= 200 && response.status < 300) {
                    log(`âœ… ${response.status} OK`, 'success');
                } else {
                    log(`âš ï¸ ${response.status} Error`, 'error');
                }

            } catch (err) {
                log(`ðŸ’¥ Erreur Critique: ${err.message}`, 'error');
            }
        }

        // 4. SystÃ¨me de Logs UI
        function log(msg, type) {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            
            const el = document.createElement('div');
            // Couleurs Tailwind dynamiques
            let color = 'text-gray-300';
            if (type === 'info') color = 'text-blue-400';
            if (type === 'success') color = 'text-green-400';
            if (type === 'error') color = 'text-red-400';

            el.className = `${color} border-l-2 border-opacity-30 pl-2 border-gray-500`;
            el.innerHTML = `<span class="text-xs text-gray-500 font-mono mr-2">[${time}]</span>${msg}`;
            
            logsDiv.prepend(el);
        }

        // 5. UX : Afficher/Masquer le champ Body
        document.getElementById('endpoint').addEventListener('change', (e) => {
            const isPost = e.target.value.includes('POST');
            document.getElementById('body-section').classList.toggle('hidden', !isPost);
        });

        // 6. Support URL Params (Pour automatisation externe basique)
        // Permet d'ouvrir index.html?endpoint=/api/status et de voir le JSON
        window.addEventListener('load', async () => {
            log('SystÃ¨me initialisÃ©. PrÃªt Ã  orchestrer.', 'success');

            const params = new URLSearchParams(window.location.search);
            const autoEndpoint = params.get('endpoint'); // ex: /api/status
            
            if (autoEndpoint) {
                log(`ðŸ¤– Automatisation dÃ©tectÃ©e: ${autoEndpoint}`, 'info');
                const method = params.get('method') || 'GET';
                const body = params.get('body') ? JSON.parse(params.get('body')) : null;

                const response = await router(method, autoEndpoint, body);
                
                // Remplacer toute la page par le JSON (pour Ãªtre lu par un script externe)
                document.body.innerHTML = `<pre style="color:white; background:black; padding:20px;">${JSON.stringify(response.data, null, 2)}</pre>`;
            }
        });

    </script>
</body>
</html>