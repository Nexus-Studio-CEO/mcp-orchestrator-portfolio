<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>RAFT | Discovery & Test Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry { font-family: 'Consolas', monospace; border-left: 3px solid #334155; padding-left: 10px; margin-bottom: 4px; }
        .success { border-color: #10b981; color: #34d399; }
        .error { border-color: #ef4444; color: #f87171; }
        .info { border-color: #3b82f6; color: #60a5fa; }
        .warning { border-color: #f59e0b; color: #fbbf24; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 p-6">

    <div class="max-w-4xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-white">üöÄ RAFT <span class="text-blue-400">Auto-Discovery</span></h1>
            <p class="text-slate-400">Tentative intelligente de chargement de la v0.1.1</p>
        </header>

        <div id="detection-panel" class="bg-slate-800 rounded-xl p-5 mb-6 border border-slate-700">
            <h2 class="text-lg font-semibold mb-4 flex items-center">
                <span class="mr-2 italic text-blue-400 font-mono">STEP 1:</span> Analyse du Module
            </h2>
            <div id="strategy-logs" class="space-y-2 text-sm"></div>
        </div>

        <div id="test-panel" class="hidden bg-black rounded-xl p-5 border border-slate-700 shadow-2xl">
            <h2 class="text-lg font-semibold mb-4 flex items-center text-emerald-400">
                <span class="mr-2 italic font-mono text-emerald-500">STEP 2:</span> Validation Fonctionnelle
            </h2>
            <div id="test-logs" class="space-y-2 text-xs h-64 overflow-y-auto"></div>
        </div>
    </div>

    <script type="module">
        const pkgUrl = 'https://cdn.jsdelivr.net/npm/@tryboy869/frontendraft@0.1.1/dist/index.js';
        const strategyLogs = document.getElementById('strategy-logs');
        const testLogs = document.getElementById('test-logs');
        const testPanel = document.getElementById('test-panel');

        function log(container, msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerHTML = `<span>[${type.toUpperCase()}]</span> ${msg}`;
            container.appendChild(div);
        }

        async function startDiscovery() {
            log(strategyLogs, `Tentative d'importation depuis : ${pkgUrl}`, 'info');
            
            try {
                // 1. Chargement dynamique du module
                const module = await import(pkgUrl);
                log(strategyLogs, `Module charg√©. Analyse des exports...`, 'success');
                console.log("Structure du module :", module);

                let FoundClass = null;
                let methodUsed = "";

                // STRAT√âGIE A : Export nomm√© { FrontendRAFT }
                if (module.FrontendRAFT) {
                    log(strategyLogs, "Strat√©gie A : Export nomm√© 'FrontendRAFT' trouv√©.", "success");
                    FoundClass = module.FrontendRAFT;
                    methodUsed = "Named Export { FrontendRAFT }";
                } 
                // STRAT√âGIE B : Export par d√©faut (default)
                else if (module.default) {
                    log(strategyLogs, "Strat√©gie B : Export par d√©faut 'default' trouv√©.", "success");
                    FoundClass = module.default;
                    methodUsed = "Default Export";
                }
                // STRAT√âGIE C : Le module est lui-m√™me la classe (CommonJS wrapper)
                else if (typeof module === 'function' || (typeof module === 'object' && Object.keys(module).length > 0)) {
                    log(strategyLogs, "Strat√©gie C : Utilisation de l'objet racine du module.", "warning");
                    FoundClass = module;
                    methodUsed = "Module Root";
                }

                if (FoundClass) {
                    runFunctionalTests(FoundClass, methodUsed);
                } else {
                    log(strategyLogs, "Aucune classe valide trouv√©e dans les exports.", "error");
                }

            } catch (err) {
                log(strategyLogs, `√âchec critique de l'import : ${err.message}`, "error");
                log(strategyLogs, "Conseil : V√©rifie si le fichier dist/index.js est bien un module ESM (contient 'export').", "warning");
            }
        }

        async function runFunctionalTests(RaftClass, method) {
            testPanel.classList.remove('hidden');
            log(testLogs, `Initialisation avec la m√©thode : <b>${method}</b>`, "info");

            try {
                // Tentative d'instanciation
                const raft = new RaftClass({ 
                    name: 'AutoDetectNode',
                    version: '0.1.1'
                });
                log(testLogs, "Instance cr√©√©e avec succ√®s.", "success");

                // Tentative de .init()
                log(testLogs, "Appel de raft.init()...", "info");
                
                // On met un timeout car si √ßa freeze, on veut savoir
                const initPromise = raft.init();
                const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout apr√®s 5s")), 5000));
                
                await Promise.race([initPromise, timeout]);
                
                log(testLogs, "‚úÖ RAFT est totalement op√©rationnel !", "success");
                log(testLogs, "Test stockage : Tentative de sauvegarde...", "info");
                
                await raft.storage.save('discovery_status', { success: true, timestamp: Date.now() });
                const check = await raft.storage.get('discovery_status');
                
                if(check.success) {
                    log(testLogs, "‚úÖ Persistance IndexedDB fonctionnelle.", "success");
                }

            } catch (err) {
                log(testLogs, `Erreur lors de l'ex√©cution : ${err.message}`, "error");
                console.error(err);
                
                if (err.message.includes("is not a constructor")) {
                    log(testLogs, "D√©tail : L'objet trouv√© n'est pas une classe (Newable).", "error");
                }
            }
        }

        startDiscovery();
    </script>
</body>
</html>