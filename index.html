<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSOP Storage Node</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code&display=swap');
        .mono { font-family: 'Fira Code', monospace; }
        .pulse-dot {
            width: 12px;
            height: 12px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 12px #10b981;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-600 to-blue-600 p-6 shadow-2xl">
        <div class="max-w-6xl mx-auto">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-black mb-1">üåê CSOP Storage Node</h1>
                    <p class="text-green-100 text-sm">IndexedDB as a Service ‚Ä¢ REST API Endpoint</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="pulse-dot"></div>
                    <span class="text-sm font-bold">ACTIVE</span>
                </div>
            </div>
            <div class="mt-4 bg-black/30 p-3 rounded-lg">
                <div class="text-xs text-green-300 mb-1">API Endpoint:</div>
                <div class="mono text-sm" id="api-endpoint">Loading...</div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-6 space-y-6">

        <!-- Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div class="text-3xl font-black text-green-400" id="stat-documents">0</div>
                <div class="text-xs text-gray-400">Documents</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div class="text-3xl font-black text-blue-400" id="stat-requests">0</div>
                <div class="text-xs text-gray-400">Requ√™tes</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div class="text-3xl font-black text-purple-400" id="stat-storage">0</div>
                <div class="text-xs text-gray-400">MB Utilis√©s</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                <div class="text-3xl font-black text-pink-400" id="stat-uptime">0s</div>
                <div class="text-xs text-gray-400">Uptime</div>
            </div>
        </div>

        <!-- API Documentation -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4">üì° REST API Endpoints</h2>
            <div class="space-y-3 text-sm">
                <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="bg-green-600 text-white px-2 py-1 rounded font-bold text-xs">POST</span>
                        <span class="mono text-gray-300">?action=write&body={...}</span>
                    </div>
                    <div class="text-gray-400 text-xs">√âcrire des donn√©es (body dans URL encoded)</div>
                </div>

                <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="bg-blue-600 text-white px-2 py-1 rounded font-bold text-xs">GET</span>
                        <span class="mono text-gray-300">?action=read&collection=users&key=user_123</span>
                    </div>
                    <div class="text-gray-400 text-xs">Lire un document</div>
                </div>

                <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="bg-blue-600 text-white px-2 py-1 rounded font-bold text-xs">GET</span>
                        <span class="mono text-gray-300">?action=list&collection=users</span>
                    </div>
                    <div class="text-gray-400 text-xs">Lister tous les documents d'une collection</div>
                </div>

                <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="bg-yellow-600 text-white px-2 py-1 rounded font-bold text-xs">PUT</span>
                        <span class="mono text-gray-300">?action=update&body={...}</span>
                    </div>
                    <div class="text-gray-400 text-xs">Mettre √† jour un document</div>
                </div>

                <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="bg-red-600 text-white px-2 py-1 rounded font-bold text-xs">DELETE</span>
                        <span class="mono text-gray-300">?action=delete&collection=users&key=user_123</span>
                    </div>
                    <div class="text-gray-400 text-xs">Supprimer un document</div>
                </div>
            </div>
        </div>

        <!-- Test Interface -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4">üß™ Test Interface</h2>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Action</label>
                        <select id="test-action" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm">
                            <option value="write">WRITE</option>
                            <option value="read">READ</option>
                            <option value="list">LIST</option>
                            <option value="update">UPDATE</option>
                            <option value="delete">DELETE</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Collection</label>
                        <input type="text" id="test-collection" value="test" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Key</label>
                        <input type="text" id="test-key" value="doc_1" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1">Data (JSON)</label>
                    <textarea id="test-data" rows="4" class="w-full bg-gray-900 border border-gray-700 rounded px-3 py-2 text-sm mono">{"message": "Hello CSOP!", "timestamp": "2025-01-01"}</textarea>
                </div>
                <button onclick="testAPI()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl">
                    Ex√©cuter Test
                </button>
            </div>
        </div>

        <!-- Response -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4">üìä Response</h2>
            <pre id="response" class="bg-gray-900 border border-gray-700 rounded p-4 text-sm mono overflow-x-auto text-green-400 min-h-24"></pre>
        </div>

        <!-- Storage View -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">üíæ Storage Browser</h2>
                <button onclick="refreshStorage()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm">
                    üîÑ Refresh
                </button>
            </div>
            <div id="storage-view" class="space-y-2"></div>
        </div>

        <!-- Logs -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4">üìù Activity Logs</h2>
            <div id="logs" class="space-y-1 text-xs mono max-h-64 overflow-y-auto"></div>
        </div>

    </div>

    <script>
        // ========== CSOP STORAGE NODE ==========
        
        const STATS = {
            documents: 0,
            requests: 0,
            storage: 0,
            startTime: Date.now()
        };

        const DB = {
            name: 'csop_storage_node',
            version: 1,
            db: null,

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB.name, DB.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        DB.db = request.result;
                        resolve(DB.db);
                    };
                    
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('storage')) {
                            const store = db.createObjectStore('storage', { keyPath: 'fullKey' });
                            store.createIndex('collection', 'collection', { unique: false });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    };
                });
            },

            async write(collection, key, data) {
                const fullKey = `${collection}:${key}`;
                const doc = {
                    fullKey,
                    collection,
                    key,
                    data,
                    timestamp: Date.now()
                };

                const tx = DB.db.transaction('storage', 'readwrite');
                const store = tx.objectStore('storage');
                
                return new Promise((resolve, reject) => {
                    const request = store.put(doc);
                    request.onsuccess = () => resolve({ success: true, key: fullKey });
                    request.onerror = () => reject(request.error);
                });
            },

            async read(collection, key) {
                const fullKey = `${collection}:${key}`;
                const tx = DB.db.transaction('storage', 'readonly');
                const store = tx.objectStore('storage');
                
                return new Promise((resolve, reject) => {
                    const request = store.get(fullKey);
                    request.onsuccess = () => {
                        if (request.result) {
                            resolve({ success: true, data: request.result.data });
                        } else {
                            reject(new Error('Key not found'));
                        }
                    };
                    request.onerror = () => reject(request.error);
                });
            },

            async list(collection) {
                const tx = DB.db.transaction('storage', 'readonly');
                const store = tx.objectStore('storage');
                const index = store.index('collection');
                
                return new Promise((resolve, reject) => {
                    const request = index.getAll(collection);
                    request.onsuccess = () => {
                        resolve({ 
                            success: true, 
                            count: request.result.length,
                            data: request.result.map(doc => ({
                                key: doc.key,
                                data: doc.data,
                                timestamp: doc.timestamp
                            }))
                        });
                    };
                    request.onerror = () => reject(request.error);
                });
            },

            async update(collection, key, data) {
                return await DB.write(collection, key, data);
            },

            async delete(collection, key) {
                const fullKey = `${collection}:${key}`;
                const tx = DB.db.transaction('storage', 'readwrite');
                const store = tx.objectStore('storage');
                
                return new Promise((resolve, reject) => {
                    const request = store.delete(fullKey);
                    request.onsuccess = () => resolve({ success: true });
                    request.onerror = () => reject(request.error);
                });
            },

            async count() {
                const tx = DB.db.transaction('storage', 'readonly');
                const store = tx.objectStore('storage');
                
                return new Promise((resolve) => {
                    const request = store.count();
                    request.onsuccess = () => resolve(request.result);
                });
            },

            async estimateSize() {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    return (estimate.usage / (1024 * 1024)).toFixed(2);
                }
                return 0;
            }
        };

        // ========== REST API HANDLER ==========
        
        async function handleRequest(urlParams) {
            STATS.requests++;
            updateStats();

            const action = urlParams.get('action');
            const collection = urlParams.get('collection');
            const key = urlParams.get('key');
            const bodyParam = urlParams.get('body');

            log(`${action?.toUpperCase() || 'UNKNOWN'} /${collection || '?'}/${key || 'all'}`, 'info');

            try {
                let body = null;
                if (bodyParam) {
                    try {
                        body = JSON.parse(decodeURIComponent(bodyParam));
                    } catch (e) {
                        throw new Error('Invalid JSON in body parameter');
                    }
                }

                let result;

                switch (action) {
                    case 'write':
                        if (!body || !body.collection || !body.key || !body.data) {
                            throw new Error('Body must contain: collection, key, data');
                        }
                        result = await DB.write(body.collection, body.key, body.data);
                        break;
                    
                    case 'read':
                        if (!collection || !key) {
                            throw new Error('collection and key required');
                        }
                        result = await DB.read(collection, key);
                        break;
                    
                    case 'list':
                        if (!collection) {
                            throw new Error('collection required');
                        }
                        result = await DB.list(collection);
                        break;
                    
                    case 'update':
                        if (!body || !body.collection || !body.key || !body.data) {
                            throw new Error('Body must contain: collection, key, data');
                        }
                        result = await DB.update(body.collection, body.key, body.data);
                        break;
                    
                    case 'delete':
                        if (!collection || !key) {
                            throw new Error('collection and key required');
                        }
                        result = await DB.delete(collection, key);
                        break;
                    
                    default:
                        throw new Error(`Invalid action: ${action}`);
                }

                log(`‚úì ${action.toUpperCase()} success`, 'success');
                return result;

            } catch (error) {
                log(`‚úó ${action?.toUpperCase() || 'REQUEST'} failed: ${error.message}`, 'error');
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // ========== URL PARAMS HANDLER ==========
        
        window.addEventListener('load', async () => {
            await DB.init();
            await updateStats();
            
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');

            // Si requ√™te API externe
            if (action) {
                try {
                    const result = await handleRequest(urlParams);
                    
                    // Retourner JSON pur
                    document.body.innerHTML = `<pre style="color: #10b981; background: #000; padding: 20px; font-family: monospace;">${JSON.stringify(result, null, 2)}</pre>`;
                    
                } catch (error) {
                    document.body.innerHTML = `<pre style="color: #ef4444; background: #000; padding: 20px; font-family: monospace;">${JSON.stringify({ 
                        success: false, 
                        error: error.message 
                    }, null, 2)}</pre>`;
                }
            } else {
                // Mode interface normale
                document.getElementById('api-endpoint').textContent = window.location.origin + window.location.pathname;
                log('üöÄ CSOP Storage Node initialis√©', 'success');
                await refreshStorage();
                startUptimeCounter();
            }
        });

        // ========== TEST INTERFACE ==========
        
        async function testAPI() {
            const action = document.getElementById('test-action').value;
            const collection = document.getElementById('test-collection').value;
            const key = document.getElementById('test-key').value;
            const dataStr = document.getElementById('test-data').value;

            try {
                let data = null;
                if (['write', 'update'].includes(action)) {
                    data = JSON.parse(dataStr);
                }

                const params = new URLSearchParams({ action, collection, key });
                
                if (data) {
                    params.set('body', JSON.stringify({ collection, key, data }));
                }

                const result = await handleRequest(params);
                
                document.getElementById('response').textContent = JSON.stringify(result, null, 2);
                await refreshStorage();
                
            } catch (error) {
                document.getElementById('response').textContent = JSON.stringify({ 
                    success: false, 
                    error: error.message 
                }, null, 2);
            }
        }

        // ========== UI FUNCTIONS ==========
        
        async function refreshStorage() {
            const result = await DB.list('test');
            const view = document.getElementById('storage-view');
            
            if (result.count === 0) {
                view.innerHTML = '<div class="text-gray-500 text-sm text-center p-4">Aucune donn√©e stock√©e</div>';
                return;
            }

            view.innerHTML = result.data.map(doc => `
                <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-3">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-purple-400">test:${doc.key}</span>
                            <span class="text-xs text-gray-600">${new Date(doc.timestamp).toLocaleString()}</span>
                        </div>
                    </div>
                    <pre class="text-xs text-gray-300 mono">${JSON.stringify(doc.data, null, 2)}</pre>
                </div>
            `).join('');
        }

        async function updateStats() {
            STATS.documents = await DB.count();
            STATS.storage = await DB.estimateSize();
            
            document.getElementById('stat-documents').textContent = STATS.documents;
            document.getElementById('stat-requests').textContent = STATS.requests;
            document.getElementById('stat-storage').textContent = STATS.storage;
        }

        function startUptimeCounter() {
            setInterval(() => {
                const uptime = Math.floor((Date.now() - STATS.startTime) / 1000);
                document.getElementById('stat-uptime').textContent = uptime + 's';
            }, 1000);
        }

        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type];
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logsDiv.insertBefore(logEntry, logsDiv.firstChild);
            
            while (logsDiv.children.length > 100) {
                logsDiv.removeChild(logsDiv.lastChild);
            }
        }
    </script>
</body>
</html>