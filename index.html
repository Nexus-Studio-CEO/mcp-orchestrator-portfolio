<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client-Side REST API</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        .mono { font-family: 'Fira Code', monospace; }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        .status-online { background: #10b981; box-shadow: 0 0 12px #10b981; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto space-y-6">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-8 rounded-2xl shadow-2xl">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-black mb-2">Client-Side REST API</h1>
                    <p class="text-blue-100">Exp√©rience : API REST dans le navigateur</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center gap-2 text-sm font-bold">
                        <span class="status-dot status-online"></span>
                        API ACTIVE
                    </div>
                    <div class="text-xs text-blue-100 mt-1 mono" id="session-id"></div>
                </div>
            </div>
        </div>

        <!-- API Info -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                üì° Endpoints disponibles
            </h2>
            <div class="space-y-2 text-sm mono">
                <div class="bg-green-900/30 border border-green-700 p-3 rounded">
                    <span class="text-green-400 font-bold">GET</span> 
                    <span class="text-gray-300">/api/status</span>
                    <span class="text-gray-500 ml-4">‚Üí √âtat du serveur</span>
                </div>
                <div class="bg-blue-900/30 border border-blue-700 p-3 rounded">
                    <span class="text-blue-400 font-bold">POST</span> 
                    <span class="text-gray-300">/api/process</span>
                    <span class="text-gray-500 ml-4">‚Üí Traitement de texte</span>
                </div>
                <div class="bg-green-900/30 border border-green-700 p-3 rounded">
                    <span class="text-green-400 font-bold">GET</span> 
                    <span class="text-gray-300">/api/data</span>
                    <span class="text-gray-500 ml-4">‚Üí Liste des donn√©es</span>
                </div>
                <div class="bg-purple-900/30 border border-purple-700 p-3 rounded">
                    <span class="text-purple-400 font-bold">PUT</span> 
                    <span class="text-gray-300">/api/data/:id</span>
                    <span class="text-gray-500 ml-4">‚Üí Mise √† jour</span>
                </div>
            </div>
        </div>

        <!-- Test Interface -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4">üß™ Interface de Test</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-400 mb-2">Endpoint</label>
                    <select id="endpoint" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white">
                        <option value="/api/status">GET /api/status</option>
                        <option value="/api/data">GET /api/data</option>
                        <option value="/api/process">POST /api/process</option>
                    </select>
                </div>

                <div id="body-section" class="hidden">
                    <label class="block text-sm font-bold text-gray-400 mb-2">Body (JSON)</label>
                    <textarea id="request-body" rows="4" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white mono text-sm" placeholder='{"text": "Votre texte ici"}'></textarea>
                </div>

                <button onclick="testAPI()" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-3 rounded-lg shadow-lg transition-all">
                    Envoyer la Requ√™te
                </button>

                <div id="response-section" class="hidden">
                    <h3 class="text-sm font-bold text-gray-400 mb-2">R√©ponse :</h3>
                    <pre id="response-output" class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-sm mono overflow-x-auto"></pre>
                </div>
            </div>
        </div>

        <!-- Logs en temps r√©el -->
        <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
            <h2 class="text-xl font-bold mb-4">üìä Logs API (Temps R√©el)</h2>
            <div id="logs" class="space-y-2 max-h-64 overflow-y-auto text-sm mono"></div>
        </div>

        <!-- Instructions pour Python -->
        <div class="bg-yellow-900/20 border border-yellow-700 p-6 rounded-xl">
            <h3 class="text-lg font-bold text-yellow-400 mb-3">üêç Test depuis Python/Colab</h3>
            <p class="text-sm text-gray-300 mb-3">Une fois cette page d√©ploy√©e, utilisez ce code Python :</p>
            <pre class="bg-gray-900 border border-gray-700 rounded-lg p-4 text-xs mono overflow-x-auto text-green-400">import requests
import json

# URL de ton HTML d√©ploy√© (GitHub Pages / Vercel)
base_url = "https://your-username.github.io/api-client.html"

# Test 1: GET status
response = requests.get(f"{base_url}?endpoint=/api/status")
print("Status:", response.json())

# Test 2: POST process
response = requests.post(
    f"{base_url}?endpoint=/api/process",
    json={"text": "Hello from Python!"}
)
print("Result:", response.json())</pre>
        </div>
    </div>

    <script>
        // ========== API REST C√îT√â CLIENT ==========
        
        const API_DATA = {
            sessionId: 'session-' + Math.random().toString(36).substr(2, 9),
            startTime: Date.now(),
            storage: [],
            requestCount: 0
        };

        document.getElementById('session-id').textContent = `Session: ${API_DATA.sessionId}`;

        // Service Worker pour intercepter les fetch
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(createServiceWorkerBlob()).then(reg => {
                log('‚úÖ Service Worker install√©', 'success');
            }).catch(err => {
                log('‚ùå Service Worker failed: ' + err.message, 'error');
            });
        }

        function createServiceWorkerBlob() {
            const swCode = `
                self.addEventListener('install', (event) => {
                    self.skipWaiting();
                });

                self.addEventListener('activate', (event) => {
                    event.waitUntil(self.clients.claim());
                });

                self.addEventListener('fetch', (event) => {
                    const url = new URL(event.request.url);
                    
                    // Intercepter uniquement les requ√™tes /api/*
                    if (url.pathname.startsWith('/api/')) {
                        event.respondWith(handleAPIRequest(event.request));
                    }
                });

                async function handleAPIRequest(request) {
                    const url = new URL(request.url);
                    const path = url.pathname;
                    const method = request.method;

                    let responseData;
                    let status = 200;

                    try {
                        if (method === 'GET' && path === '/api/status') {
                            responseData = {
                                status: 'online',
                                message: 'API Client-Side active',
                                uptime: Date.now() - ${API_DATA.startTime},
                                sessionId: '${API_DATA.sessionId}',
                                timestamp: new Date().toISOString()
                            };
                        }
                        else if (method === 'GET' && path === '/api/data') {
                            responseData = {
                                data: [],
                                count: 0,
                                message: 'Liste des donn√©es'
                            };
                        }
                        else if (method === 'POST' && path === '/api/process') {
                            const body = await request.json();
                            const text = body.text || '';
                            
                            responseData = {
                                original: text,
                                processed: {
                                    uppercase: text.toUpperCase(),
                                    lowercase: text.toLowerCase(),
                                    reversed: text.split('').reverse().join(''),
                                    length: text.length,
                                    words: text.split(' ').length
                                },
                                timestamp: new Date().toISOString()
                            };
                        }
                        else {
                            status = 404;
                            responseData = { error: 'Endpoint not found' };
                        }
                    } catch (error) {
                        status = 500;
                        responseData = { error: error.message };
                    }

                    return new Response(JSON.stringify(responseData), {
                        status: status,
                        headers: {
                            'Content-Type': 'application/json',
                            'Access-Control-Allow-Origin': '*',
                            'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
                            'Access-Control-Allow-Headers': 'Content-Type'
                        }
                    });
                }
            `;

            const blob = new Blob([swCode], { type: 'application/javascript' });
            return URL.createObjectURL(blob);
        }

        // Simulateur d'API sans Service Worker (fallback)
        async function handleLocalAPI(endpoint, method = 'GET', body = null) {
            API_DATA.requestCount++;
            log(`${method} ${endpoint}`, 'info');

            let response;

            if (method === 'GET' && endpoint === '/api/status') {
                response = {
                    status: 'online',
                    message: 'API Client-Side active (Fallback mode)',
                    uptime: Date.now() - API_DATA.startTime,
                    sessionId: API_DATA.sessionId,
                    requestCount: API_DATA.requestCount,
                    timestamp: new Date().toISOString()
                };
            }
            else if (method === 'GET' && endpoint === '/api/data') {
                response = {
                    data: API_DATA.storage,
                    count: API_DATA.storage.length,
                    message: 'Liste des donn√©es'
                };
            }
            else if (method === 'POST' && endpoint === '/api/process') {
                const text = body.text || '';
                response = {
                    original: text,
                    processed: {
                        uppercase: text.toUpperCase(),
                        lowercase: text.toLowerCase(),
                        reversed: text.split('').reverse().join(''),
                        length: text.length,
                        words: text.split(' ').length,
                        vowels: (text.match(/[aeiou]/gi) || []).length
                    },
                    timestamp: new Date().toISOString()
                };
            }
            else if (method === 'PUT' && endpoint.startsWith('/api/data/')) {
                const id = endpoint.split('/').pop();
                response = {
                    message: `Updated item ${id}`,
                    data: body
                };
            }
            else {
                throw new Error('Endpoint not found');
            }

            log(`‚úì Response: ${JSON.stringify(response).substr(0, 50)}...`, 'success');
            return response;
        }

        // Test depuis l'interface
        async function testAPI() {
            const endpoint = document.getElementById('endpoint').value;
            const method = endpoint.includes('POST') ? 'POST' : endpoint.includes('PUT') ? 'PUT' : 'GET';
            const path = endpoint.split(' ')[1];

            let body = null;
            if (method === 'POST' || method === 'PUT') {
                const bodyText = document.getElementById('request-body').value;
                try {
                    body = bodyText ? JSON.parse(bodyText) : {};
                } catch (e) {
                    log('‚ùå Invalid JSON', 'error');
                    return;
                }
            }

            try {
                const result = await handleLocalAPI(path, method, body);
                document.getElementById('response-section').classList.remove('hidden');
                document.getElementById('response-output').textContent = JSON.stringify(result, null, 2);
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Gestion des query params pour Python
        window.addEventListener('load', async () => {
            const params = new URLSearchParams(window.location.search);
            const endpoint = params.get('endpoint');
            const bodyParam = params.get('body');

            if (endpoint) {
                log(`üì° Requ√™te externe d√©tect√©e: ${endpoint}`, 'info');
                
                try {
                    let body = null;
                    if (bodyParam) {
                        body = JSON.parse(decodeURIComponent(bodyParam));
                    }

                    const method = params.get('method') || 'GET';
                    const result = await handleLocalAPI(endpoint, method, body);
                    
                    // Retourner la r√©ponse
                    document.body.innerHTML = `<pre>${JSON.stringify(result, null, 2)}</pre>`;
                } catch (error) {
                    document.body.innerHTML = `<pre>{"error": "${error.message}"}</pre>`;
                }
            }
        });

        // Logs
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-400',
                success: 'text-green-400',
                error: 'text-red-400'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `${colors[type]} flex gap-2`;
            logEntry.innerHTML = `<span class="text-gray-600">[${timestamp}]</span> ${message}`;
            
            logsDiv.insertBefore(logEntry, logsDiv.firstChild);
            
            // Garder seulement les 20 derniers logs
            while (logsDiv.children.length > 20) {
                logsDiv.removeChild(logsDiv.lastChild);
            }
        }

        // Afficher/masquer le body selon l'endpoint
        document.getElementById('endpoint').addEventListener('change', (e) => {
            const isPost = e.target.value.includes('POST');
            document.getElementById('body-section').classList.toggle('hidden', !isPost);
        });

        // Log initial
        log('üöÄ API Client-Side initialis√©e', 'success');
        log(`Session ID: ${API_DATA.sessionId}`, 'info');
    </script>
</body>
</html>